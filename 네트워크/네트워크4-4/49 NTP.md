# 제목 없음

49 NTP

# NTP란?

컴퓨터나 서버 내부에는 시계를 가지고 있어 그 시간으로 파일의 타임스탬프를 기록하거나 로그 파일의 시간 정보로 사용한다. 그러나 시계에는 오차가 있고 모든 컴퓨터가 시간이 올바르게 설정되어 있는 것은 아니다.
Network Time Protocol의 약어로 네트워크로 연결되어 있는 컴퓨터들끼리 클록 시각을 동기화시키는 데 사용되는 프로토콜이다.

# NTP 서버

Stratum1 서버에서는 원자시계 또는 GPS와 같은 정밀한 시간 소스를 사용하여 시간을 동기화한다. Stratum2 서버는 Stratum 1 서버와 통신하여 시간 정보를 받아온다. 나머지 Stratum 서버는 2에서 얻은 시간 정보를 기반으로 동작하며, 계층적 구조를 형성한다.
네트워크 상의 클라이언트들에 대해 정확한 시간 정보를 제공하는 역할을 한다. 이 서버는 전 세계적으로 분산된 여러 위치에 존재하며, 계층 구조를 이루어 전체 시스템이 안정적으로 동작하도록 한다.
NTP 서버는 계층화된 Stratum이라는 수준을 가지고 있습니다. Stratum 1은 가장 정확하고 안정된 시간 정보를 제공하는 서버를 나타내며, 이 서버는 직접적인 시간 소스를 사용한다. 그 아래로는 Stratum 2, Stratum 3, 이와 같이 계속 내려가며 계층이 형성된다. 클라이언트는 가능한 한 낮은 Stratum의 서버와 통신하여 정확한 시간 정보를 얻는다.
NTP는 클라이언트와 서버 간에 특별한 패킷을 교환하여 동기화를 유지한다. 이 패킷에는 시간 정보와 네트워크 지연 등의 데이터가 포함되어 있다. NTP는 클라이언트와 서버 간의 지연을 고려하여 정확한 동기화를 제공하기 위해 알고리즘을 사용한다. -> 하위 서버는 상위 서버에 요청을 하고 자신의 로컬 시간을 타임스탬프를 찍으며 계산하고 자신의 로컬 시간을 계산한 값으로 맞추고 다시 하위 서버에게 보내준다.
보안 면에서도 인증 메커니즘과 암호화를 지원하여 외부로부터의 악의적인 간섭을 방지한다.

## NTP 서버가 시간을 정확하게 맞추는 방법

NTP는 클라이언트와 서버 간에 특별한 패킷을 교환하여 동기화를 유지한다. 이 패킷에는 시간 정보와 네트워크 지연 등의 데이터가 포함되어 있다.
-> 패킷에는 이러한 것들이 포함되어 있다.

- T1: 클라이언트가 패킷을 보낼 때의 로컬 시각.
- T2: 서버가 패킷을 받은 시각.
- T3: 서버가 패킷을 보낼 때의 로컬 시각.
- T4: 클라이언트가 패킷을 받은 시각.
- Originate Timestamp (T1): 클라이언트가 패킷을 생성한 시각.
- Receive Timestamp (T2): 서버가 패킷을 받은 시각.
- Transmit Timestamp (T3): 서버가 패킷에 대한 응답으로 패킷을 보낸 시각.

NTP는 클라이언트와 서버 간의 지연을 고려하여 정확한 동기화를 제공하기 위해 알고리즘을 사용한다.
-> 알고리즘은 크게 세 가지 주요 단계로 나뉜다.

1. Round-trip Delay 계산
Round-trip Delay는 T4 - T1로 계산 이는 클라이언트가 패킷을 보내고 받는 데 걸린 전체 시간이다.
이 값을 반으로 나누어 단방향 지연을 계산합니다.
2. Offset 계산
(T2 - T1 + T3 - T4) / 2로 계산 이는 서버와 클라이언트 간의 시간 차이
클라이언트는 이 Offset을 사용하여 서버의 시간을 자신의 로컬 시간에 맞춘다.
3. 클럭 드리프 보상
NTP는 클라이언트와 서버 간의 정확한 지연 및 시간 차이를 계산한 후 클럭 드리프를 보상하여 정확한 동기화를 유지
클럭 드리프는 클럭이 얼마나 빨리 또는 느리게 진행되고 있는지를 나타낸다.

쉽게 말해

1. 하위 서버는 상위 서버에 시간을 요청
2. 상위 서버는 하위 서버에 응답으로 시간을 보내줌
3. 하위 서버는 자신의 로컬 시간에 맞춰 행동을 취한 시간을 전부 기록
4. 해당 값을 토대로 계산하여 자신의 로컬 시간을 변경
5. 더 하위 서버에도 같은 방법을 반복한다.