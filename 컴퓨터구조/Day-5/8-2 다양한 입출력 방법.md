8-2 다양한 입출력 방법

입출력 작업을 수행하기 위해서는 CPU와 장치 컨트롤러가 정보를 주고받아야 한다.

# 프로그램 입출력
programmed I/O 프로그램 입출력은 기본적으로 **프로그램 속 명령어로 입출력장치를 제어**하는 방법이다.
**CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다.** 메모리에 저장된 정보를 하드 디스크에 백업하는 상황을 가정해 보자.

1. 우선 CPU는 하드 디스크 컨트롤러의 제어 레지스터에 쓰기 명령을 보낸다.

2. 하드 디스크 컨트롤러는 하드 디스크 상태를 확인한다, 하드 디스크가 준비된 상태라면 하드 디스크 컨트롤러는 상태 레지스터에 준비되었다고 표시한다.

3. CPU는 상태 레지스터를 주기적으로 읽어보며 하드 디스크의 준비 여부를 확인한다, 하드 디스크가 준비 됐음을 CPU가 알게 되면 백업할 메모리의 정보를 데이터 레지스터에 쓴다, 아직 백업 작업이 끝나지 않았다면 1. 번부터 반복하고, 쓰기가 끝났다면 작업을 종료한다.

프로그램 입출력 방식에서의 입출력 작업은 CPU가 장치 컨트롤러의 레지스터 값을 읽고 씀으로써 이루어진다. 


**CPU가 입출력장치들의 주소를 아는법**
CPU가 여러 장치 컨트롤러 속 레지스터들을 모두 알고 있기란 힘들다. 여기에는 크게 두 가지 방식이 있다. **메모리 맵 입출력**, **고립형 입출력**이다.

## 메모리 맵 입출력
메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 **주소 공간**을 하나의 **주소 공간**으로 간주하는 방법이다.
예를 들어 1024개의 주소를 표현할 수 있는 컴퓨터가 있을때 512개는 메모리 주소를, 512개는 장치 컨트롤러의 레지스터를 표현하기 위해 사용한다.

간단하게 메모리 맵 입출력 방식에서 CPU는 메모리의 주소들이나 장치 컨트롤러의 레지스터들이나 모두 똑같이 메모리 주소를 대하듯 하면 된다. 메모리에 접근하는 명령어와 입출력장치에 접근하는 명령어는 굳이 다를 필요가 없다.

## 고립형 입출력
메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법이다.
1024개의 주소 공간을 가진 컴퓨터가 있다 가정하자.
고립형 입출력의 경우에는 **메모리 읽기/쓰기**, **입출력장치 읽기/쓰기**선이 따로 있다.
CPU가 메모리 읽기/쓰기 선이 활성화되는 명령어를 실행할 때는 메모리에 접근하고, 입출력장치 읽기/쓰기 선이 활성화되는 명령어를 실행할 때는 장치 컨트롤러에 접근

# 인터럽트 기반 입출력
**복습**
- 인터럽트는 CPU가 입출력장치에 처리할 내용을 명령하면 입출력장치가 명령어를 수행하는 동안 CPU는 다른 일을 할 수 있다라고 배웠다.
- 입출력장치가 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 멈추고 해당 인터럽트를 처리하는 프로그램인 인터럽트 서비스 루틴을 실행한 뒤 다시 하던 일로 되돌아온다.

- 입출력장치에 의한 하드웨어 인터럽트는 정확히 말하자면 입출력장치가 아닌 장치 컨트롤러에 의해 발생한다.
- CPU가 장치 컨트롤러에 입출력 작업을 명령, 장치 컨트롤러는 그동안 입출력장치를 제어한다.
- 장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 백업하고 인터럽트 서비스 루틴을 실행한다.

이와 반대되는 개념으로 폴링이라는 개념이 있다. 폴링은 입출력장치의 상태는 어떤지, 처리할 데이터가 있는지를 주기적으로 확인하는 방식이다.(CPU의 부담이 크다.)

## 입출력 장치가 많을 때 예시

**1. 인터럽트가 발생한 순서대로 처리하는 방법**
- 도중에 다른 인터럽트가 발생하여도 먼저 발생한 인터럽트 서비스 루틴을 실행 뒤 다음 것을 실행한다.
- 그렇지만 현실적으로 모든 인터럽트를 전부 순차적으로만 해결할 수 없다.



**2. 우선순위 대로 처리하는 방법**
- 플래그 레지스터 속 인터럽트 비트가 비활성화되어 있는 경우, 혹은 인터럽트 비트를 비활성화해도 무시할 수 없는 인터럽트인 NMI(Non-Maskable Interrupt)발생시 우선순위가 높은 인터럽트부터 처리한다.
- 다중 인터럽트를 처리하는 방법에는 여러가지가 있음 대부분은 프로그래머블 인터럽트 컨트롤러(PIC)라는 하드웨어를 사용한다.
- PIC는 여러 장치 컨트롤러에 연결되어 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야 할 하드웨어 인터럽트는 무엇인지를 알려주는 장치이다.
- PIC에는 여러 핀이 있다. 각 핀에는 CPU에 하드웨어 인터럽트 요청을 보낼 수 있는 약속된 하드웨어가 연결되어 있다.
- PIC에 연결된 장치 컨트롤러들이 동시에 하드웨어 인터럽트 요청을 보내면 PIC는 이들의 우선순위를 판단하여 CPU에 가장 먼저 처리할 인터럽트를 알려준다.

### 과정
1. PIC가 장치 컨트롤러에서 인터럽트 요청 신호를 받아들인다.
2. PIC는 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보낸다.
3. CPU는 PIC에 인터럽트 확인 신호를 보낸다.
4. PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보낸다.
5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 인터럽트 서비스 루틴을 실행한다.


# DMA 입출력
위의 **프로그램 기반 입출력**, **인터럽트 기반 입출력**에 공통점이 있다면 입출력장치와 메모리 간의 데이터 이동은 CPU가 주도하고, 이동하는 데이터도 반드시 CPU를 거친다는 것이다.


### EX)
입출력장치 데이터를 메모리에 저장하는 경우 CPU는 **장치 컨트롤러**에서 **입출력장치** 데이터를 하나씩 읽어 레지스터에 적재하고, 적재한 데이터를 메모리에 저장한다.

이렇게 **입출력장치**와 **메모리**사이에 전송되는 모든 데이터가 CPU를 거쳐야 한다면 그리고 만약 하드 디스크 백업과 같이 대용량 데이터를 옮길 때는 CPU 부담이 더욱 커질것이다.

그렇기에 입출력장치와 메모리가 CPU를 거치지 않고도 상호작용할 수 있는 입출력 방식인 **DMA**(Direct Memory Access)가 등장.
DMA는 직접 메모리에 접근할 수 있는 입출력 기능이다.
DMA 입출력을 하기 위해서는 시스템 버스에 연결된 **DMA 컨트롤러**라는 하드웨어가 필요하다.

### DMA 입출력 과정
1. CPU는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산(읽기/쓰기), 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령
2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다. 이때 DMA 컨트롤러는 필요한 경우 메모리에 직접 접근하여 정보를 읽거나 쓴다.
3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알린다.

### 정리
- CPU는 DMA 컨트롤러에게 입출력 작업 명령을 내리고, 인터럽트만 받으면 되기에 작업 부담을 줄일 수 있다.
- CPU는 오로지 인터럽트의 시작과 끝에만 관여하면 된다.

한 가지 중요한점은 **시스템 버스**는 동시 사용이 불가능하다.(공용 자원이기 때문에) DMA 컨트롤러는 시스템 버스로 메모리에 직접 접근이 가능하다. 이렇기에 CPU가 시스템 버스를 사용할 때 DMA 컨트롤러는 시스템 버스를 사용할 수 없다.

1. DMA 컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템 버스를 이용
2. CPU가 일시적으로 시스템 버스를 이용하지 않도록 허락을 구하고 시스템 버스를 집중적으로 이용한다.
> CPU입장에서는 버스에 접근하는 주기를 도둑맞는것과 비슷할 듯하다. 이러한 이용을 사이클 스틸링이라고도 부른다.

### 입출력 버스
CPU, 메모리, DMA 컨트롤러, 장치 컨트롤러가 모두 같은 버스를 공유하는 구성에서는 DMA를 위해 한 번 메모리에 접근할 때마다 시스템 버스를 두 번 사용하는 부작용이 있다.

이 문제는 DMA 컨트롤러와 장치 컨트롤러들을 **입출력 버스**라는 별도의 버스에 연결하여 해결할 수 있다.
즉 **시스템 버스가 아닌 DMA 컨트롤러와 장치 컨트롤러가 서로 데이터를 전송할 때는 시스템 버스를 이용할 필요가 없다.**

대부분의 입출력장치는 시스템 버스가 아닌 입출력 버스와 연결된다. 입출력 버스는 입출력장치를 컴퓨터 내부와 연결 짓는 통로라고도 볼 수 있다.

### 입출력 버스 종류
**PCI 버스**, **PCI Express(PCle) 버스**등 여러 종류가 있다. 입출력장치들을 PCle 버스와 연결해 주는 통로인 PCle 슬롯이다.